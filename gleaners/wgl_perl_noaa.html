<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <link rel='canonical' href='https://waconia.triquence.org/gleaners/wgl_perl_noaa.html' />
  <title>wgl_perl_noaa</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #49483e }
body { background: #272822; color: #F8F8F2 }
body .c { color: #959077 } /* Comment */
body .err { color: #ED007E; background-color: #1E0010 } /* Error */
body .esc { color: #F8F8F2 } /* Escape */
body .g { color: #F8F8F2 } /* Generic */
body .k { color: #66D9EF } /* Keyword */
body .l { color: #AE81FF } /* Literal */
body .n { color: #F8F8F2 } /* Name */
body .o { color: #FF4689 } /* Operator */
body .x { color: #F8F8F2 } /* Other */
body .p { color: #F8F8F2 } /* Punctuation */
body .ch { color: #959077 } /* Comment.Hashbang */
body .cm { color: #959077 } /* Comment.Multiline */
body .cp { color: #959077 } /* Comment.Preproc */
body .cpf { color: #959077 } /* Comment.PreprocFile */
body .c1 { color: #959077 } /* Comment.Single */
body .cs { color: #959077 } /* Comment.Special */
body .gd { color: #FF4689 } /* Generic.Deleted */
body .ge { color: #F8F8F2; font-style: italic } /* Generic.Emph */
body .ges { color: #F8F8F2; font-weight: bold; font-style: italic } /* Generic.EmphStrong */
body .gr { color: #F8F8F2 } /* Generic.Error */
body .gh { color: #F8F8F2 } /* Generic.Heading */
body .gi { color: #A6E22E } /* Generic.Inserted */
body .go { color: #66D9EF } /* Generic.Output */
body .gp { color: #FF4689; font-weight: bold } /* Generic.Prompt */
body .gs { color: #F8F8F2; font-weight: bold } /* Generic.Strong */
body .gu { color: #959077 } /* Generic.Subheading */
body .gt { color: #F8F8F2 } /* Generic.Traceback */
body .kc { color: #66D9EF } /* Keyword.Constant */
body .kd { color: #66D9EF } /* Keyword.Declaration */
body .kn { color: #FF4689 } /* Keyword.Namespace */
body .kp { color: #66D9EF } /* Keyword.Pseudo */
body .kr { color: #66D9EF } /* Keyword.Reserved */
body .kt { color: #66D9EF } /* Keyword.Type */
body .ld { color: #E6DB74 } /* Literal.Date */
body .m { color: #AE81FF } /* Literal.Number */
body .s { color: #E6DB74 } /* Literal.String */
body .na { color: #A6E22E } /* Name.Attribute */
body .nb { color: #F8F8F2 } /* Name.Builtin */
body .nc { color: #A6E22E } /* Name.Class */
body .no { color: #66D9EF } /* Name.Constant */
body .nd { color: #A6E22E } /* Name.Decorator */
body .ni { color: #F8F8F2 } /* Name.Entity */
body .ne { color: #A6E22E } /* Name.Exception */
body .nf { color: #A6E22E } /* Name.Function */
body .nl { color: #F8F8F2 } /* Name.Label */
body .nn { color: #F8F8F2 } /* Name.Namespace */
body .nx { color: #A6E22E } /* Name.Other */
body .py { color: #F8F8F2 } /* Name.Property */
body .nt { color: #FF4689 } /* Name.Tag */
body .nv { color: #F8F8F2 } /* Name.Variable */
body .ow { color: #FF4689 } /* Operator.Word */
body .pm { color: #F8F8F2 } /* Punctuation.Marker */
body .w { color: #F8F8F2 } /* Text.Whitespace */
body .mb { color: #AE81FF } /* Literal.Number.Bin */
body .mf { color: #AE81FF } /* Literal.Number.Float */
body .mh { color: #AE81FF } /* Literal.Number.Hex */
body .mi { color: #AE81FF } /* Literal.Number.Integer */
body .mo { color: #AE81FF } /* Literal.Number.Oct */
body .sa { color: #E6DB74 } /* Literal.String.Affix */
body .sb { color: #E6DB74 } /* Literal.String.Backtick */
body .sc { color: #E6DB74 } /* Literal.String.Char */
body .dl { color: #E6DB74 } /* Literal.String.Delimiter */
body .sd { color: #E6DB74 } /* Literal.String.Doc */
body .s2 { color: #E6DB74 } /* Literal.String.Double */
body .se { color: #AE81FF } /* Literal.String.Escape */
body .sh { color: #E6DB74 } /* Literal.String.Heredoc */
body .si { color: #E6DB74 } /* Literal.String.Interpol */
body .sx { color: #E6DB74 } /* Literal.String.Other */
body .sr { color: #E6DB74 } /* Literal.String.Regex */
body .s1 { color: #E6DB74 } /* Literal.String.Single */
body .ss { color: #E6DB74 } /* Literal.String.Symbol */
body .bp { color: #F8F8F2 } /* Name.Builtin.Pseudo */
body .fm { color: #A6E22E } /* Name.Function.Magic */
body .vc { color: #F8F8F2 } /* Name.Variable.Class */
body .vg { color: #F8F8F2 } /* Name.Variable.Global */
body .vi { color: #F8F8F2 } /* Name.Variable.Instance */
body .vm { color: #F8F8F2 } /* Name.Variable.Magic */
body .il { color: #AE81FF } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="c1"># wgl_perl_noaa.pl</span>
<span class="c1"># Weather Gleaner for NOAA webpages.</span>
<span class="c1"># Jim Miller, 10:45 AM Sat July 5, 2025</span>

<span class="k">use</span><span class="w"> </span><span class="nn">LWP::Simple</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">Time::Local</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">Date::Calc</span><span class="w"> </span><span class="sx">qw(Decode_Date_US Now Today)</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">Date::Manip</span><span class="w"> </span><span class="sx">qw(ParseDate DateCalc UnixDate)</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">DateTime</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">JSON</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="nn">lib</span><span class="w"> </span><span class="s">&#39;.&#39;</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">wgl_perl_module</span><span class="w"> </span><span class="sx">qw(connect_database get_null execute_sql close_database</span>
<span class="sx">               add_google_sheet_row clear_google_sheet_data </span>
<span class="sx">               get_google_sheet_row_count send_to_google_sheet open_log_file)</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="nn">strict</span><span class="p">;</span>

<span class="c1"># Global variables</span>
<span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindDir</span><span class="p">,</span><span class="w"> </span><span class="nv">$WindAvg</span><span class="p">,</span><span class="w"> </span><span class="nv">$WindMax</span><span class="p">,</span><span class="w"> </span><span class="nv">$TempAvg</span><span class="p">,</span><span class="w"> </span><span class="nv">$DewPoint</span><span class="p">,</span><span class="w"> </span><span class="nv">$BPAvg</span><span class="p">);</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$log_fh</span><span class="p">;</span><span class="w"> </span><span class="c1"># Global filehandle for logging</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$googleSheet_data</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">%shortNames</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$TelemOK</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$cnTelem</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$database_type</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$null</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$content</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">@thelines</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$nlines</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">@thewords</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$foundPage</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheCity</span><span class="p">,</span><span class="w"> </span><span class="nv">$StationNumber</span><span class="p">,</span><span class="w"> </span><span class="nv">$PressureStuff</span><span class="p">,</span><span class="w"> </span><span class="nv">$FirstLetter</span><span class="p">,</span><span class="w"> </span><span class="nv">$thetime</span><span class="p">,</span><span class="w"> </span><span class="nv">$ParsedDate</span><span class="p">,</span><span class="w"> </span><span class="nv">$PSTDate</span><span class="p">,</span><span class="w"> </span><span class="nv">$err</span><span class="p">);</span>
<span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheDate</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheHour</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheMin</span><span class="p">);</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$TZ</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$WindDir_string</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$Gust</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$WindStuff</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$PerlTime</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$sql</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$NextDayDate</span><span class="p">;</span>

<span class="c1"># \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>

<span class="c1"># Subroutines</span>

<span class="k">sub</span><span class="w"> </span><span class="nf">cS</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="c1"># clearString (cS)</span>
<span class="w">   </span><span class="c1"># This prepares values before writing to the Google sheet.</span>
<span class="w">   </span><span class="c1"># It translates the database NULL value to an empty string.</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$stringValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$stringValue</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="nv">$null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nv">$stringValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nv">$stringValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub</span><span class="w"> </span><span class="nf">WriteToMDB</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$TheDate_mysql</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DateTimeStamp</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DateTimeStamp_mysql</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$LiteralDateTimeStamp</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$Waconia_Year</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Month</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Day</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Hour</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Min</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Sec</span><span class="p">);</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">@newRow_googleSheet</span><span class="p">;</span>

<span class="w">   </span><span class="p">(</span><span class="nv">$Waconia_Hour</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Min</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Sec</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Now</span><span class="p">();</span>
<span class="w">   </span><span class="p">(</span><span class="nv">$Waconia_Year</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Month</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Day</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Today</span><span class="p">();</span>

<span class="w">   </span><span class="c1"># The following scaler, PerlTime, is useful for having a single field to</span>
<span class="w">   </span><span class="c1"># characterize time. Note this function expects months to start at zero and</span>
<span class="w">   </span><span class="c1"># years to be relative to 1900.</span>
<span class="w">   </span><span class="nv">$PerlTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timelocal</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="nv">$Waconia_Min</span><span class="p">),(</span><span class="nv">$Waconia_Hour</span><span class="p">),</span><span class="nv">$Waconia_Day</span><span class="p">,(</span><span class="nv">$Waconia_Month</span><span class="o">-</span><span class="mi">1</span><span class="p">),(</span><span class="nv">$Waconia_Year</span><span class="p">));</span>

<span class="w">   </span><span class="c1"># Create the sql statement for inserting a record of data into the mdb file.</span>

<span class="w">   </span><span class="c1"># If there is a funny 24 in the time stamp, convert it to a more normal 0 to 23 convention...</span>
<span class="w">   </span><span class="c1"># (apparently this never gets used...)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheHour</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nv">$TheDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnixDate</span><span class="p">(</span><span class="w"> </span><span class="nn">Date::Manip::</span><span class="n">DateCalc</span><span class="p">(</span><span class="w"> </span><span class="nv">$TheDate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;+ 1 days&quot;</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%m/%d/%Y&quot;</span><span class="p">);</span><span class="w"> </span>
<span class="w">      </span><span class="nv">$TheHour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span>
<span class="w">   </span>
<span class="w">   </span><span class="c1"># If there&#39;s no data (i.e. N/A), set it to the database-appropriate NULL value.</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindDir</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$null</span><span class="p">};</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindAvg</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$null</span><span class="p">};</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindMax</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$null</span><span class="p">};</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$TempAvg</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$null</span><span class="p">};</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$DewPoint</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$DewPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$null</span><span class="p">};</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$BPAvg</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$BPAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$null</span><span class="p">};</span>

<span class="w">   </span><span class="nv">$DateTimeStamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$TheDate</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$TheHour</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$TheMin</span><span class="p">;</span>
<span class="w">   </span><span class="c1"># Format $LiteralDateTimeStamp to a more standard format</span>
<span class="w">   </span><span class="nv">$LiteralDateTimeStamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnixDate</span><span class="p">(</span><span class="nv">$ParsedDate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="p">);</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1"># Note that in the VALUES part of the SQL, strings and dates are quoted, numbers are not.</span>
<span class="w">   </span><span class="nv">$sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;INSERT INTO FifteenMinData (PerlTime, DateTimeStamp, LiteralDateTimeStamp, TimeMDY, TimeHr, TimeMin, StationNumber, StationName, &quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$sql</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s">&quot;WindDirection, WindSpeed, WindGust, &quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$sql</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s">&quot;TempAvg, DewPoint, Pressure) &quot;</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1"># Handle different date formats for MySQL vs Access</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$database_type</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;access&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nv">$sql</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s">&quot;VALUES ($PerlTime,&#39;$DateTimeStamp&#39;,&#39;$LiteralDateTimeStamp&#39;,&#39;$TheDate&#39;,$TheHour,$TheMin,$StationNumber,&#39;$TheCity&#39;,&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="nv">$database_type</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;mysql&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="c1"># MySQL format (YYYY-MM-DD)</span>
<span class="w">       </span><span class="c1"># Convert from MM/DD/YYYY to YYYY-MM-DD</span>
<span class="w">       </span><span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$month</span><span class="p">,</span><span class="w"> </span><span class="nv">$day</span><span class="p">,</span><span class="w"> </span><span class="nv">$year</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheDate</span><span class="p">);</span>
<span class="w">       </span>
<span class="w">       </span><span class="c1"># Now that we&#39;re using %Y in UnixDate, we always get 4-digit years</span>
<span class="w">       </span><span class="nv">$TheDate_mysql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&quot;%04d-%02d-%02d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">$year</span><span class="p">,</span><span class="w"> </span><span class="nv">$month</span><span class="p">,</span><span class="w"> </span><span class="nv">$day</span><span class="p">);</span>
<span class="w">       </span><span class="nv">$DateTimeStamp_mysql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&quot;%04d-%02d-%02d %02d:%02d:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">$year</span><span class="p">,</span><span class="w"> </span><span class="nv">$month</span><span class="p">,</span><span class="w"> </span><span class="nv">$day</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheHour</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheMin</span><span class="p">);</span>
<span class="w">       </span><span class="nv">$sql</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s">&quot;VALUES ($PerlTime,&#39;$DateTimeStamp_mysql&#39;,&#39;$LiteralDateTimeStamp&#39;,&#39;$TheDate_mysql&#39;,$TheHour,$TheMin,$StationNumber,&#39;$TheCity&#39;,&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="nv">$sql</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s">&quot;$WindDir,$WindAvg,$WindMax,&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$sql</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s">&quot;$TempAvg,$DewPoint,$BPAvg)&quot;</span><span class="p">;</span>

<span class="w">   </span><span class="c1">#print &quot;SQL = $sql\n&quot;;</span>

<span class="w">   </span><span class="c1"># If all numeric values are reasonable, write the record...</span>
<span class="w">   </span><span class="c1"># Note: one of these raw values may be an &quot;N/A&quot; string. Those cases always evaluate true and do not block the write. </span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">-</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w">  </span><span class="mi">120</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">       </span><span class="p">((</span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">&gt;=</span><span class="w">   </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w">  </span><span class="mi">110</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">       </span><span class="p">((</span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">&gt;=</span><span class="w">   </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">&lt;=</span><span class="w">  </span><span class="mi">130</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">       </span><span class="p">(((</span><span class="nv">$BPAvg</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">28.50</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$BPAvg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">31.00</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nv">$BPAvg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">       </span><span class="p">((</span><span class="nv">$TheHour</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheHour</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">24</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">       </span><span class="p">((</span><span class="nv">$TheMin</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheMin</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">59</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">      </span><span class="c1"># Print the intended write to the database.</span>
<span class="w">      </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;$TheDate, $TheHour, $TheMin, $StationNumber, $TheCity, $TempAvg, $DewPoint, $WindStuff, $WindDir, $WindAvg, $WindMax, $BPAvg\n&quot;</span><span class="p">;</span>

<span class="w">      </span><span class="c1"># Execute the sql using the module function</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$TelemOK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$success</span><span class="p">,</span><span class="w"> </span><span class="nv">$error</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">execute_sql</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span><span class="w"> </span><span class="nv">$log_fh</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">            </span>
<span class="w">            </span><span class="c1"># Prepare to add a new row to the googleSheet_data array.</span>
<span class="w">            </span><span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheYear</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheMonth</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheDay</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Decode_Date_US</span><span class="p">(</span><span class="nv">$TheDate</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1"># Add row to Google Sheet data using the module function</span>
<span class="w">            </span><span class="c1"># The module will handle DateTime creation and UTC conversion</span>
<span class="w">            </span><span class="n">add_google_sheet_row</span><span class="p">(</span>
<span class="w">                </span><span class="nv">$shortNames</span><span class="p">{</span><span class="nv">$TheCity</span><span class="p">},</span><span class="w">  </span><span class="c1"># station</span>
<span class="w">                </span><span class="nv">$TheYear</span><span class="p">,</span><span class="w">               </span><span class="c1"># year</span>
<span class="w">                </span><span class="nv">$TheMonth</span><span class="p">,</span><span class="w">              </span><span class="c1"># month</span>
<span class="w">                </span><span class="nv">$TheDay</span><span class="p">,</span><span class="w">                </span><span class="c1"># day</span>
<span class="w">                </span><span class="nv">$TheHour</span><span class="p">,</span><span class="w">               </span><span class="c1"># hour</span>
<span class="w">                </span><span class="nv">$TheMin</span><span class="p">,</span><span class="w">                </span><span class="c1"># minute</span>
<span class="w">                </span><span class="n">cS</span><span class="p">(</span><span class="nv">$TempAvg</span><span class="p">),</span><span class="w">           </span><span class="c1"># temp_avg</span>
<span class="w">                </span><span class="n">cS</span><span class="p">(</span><span class="nv">$DewPoint</span><span class="p">),</span><span class="w">          </span><span class="c1"># dew_point</span>
<span class="w">                </span><span class="n">cS</span><span class="p">(</span><span class="nv">$WindDir</span><span class="p">),</span><span class="w">           </span><span class="c1"># wind_dir</span>
<span class="w">                </span><span class="n">cS</span><span class="p">(</span><span class="nv">$WindAvg</span><span class="p">),</span><span class="w">           </span><span class="c1"># wind_avg</span>
<span class="w">                </span><span class="n">cS</span><span class="p">(</span><span class="nv">$WindMax</span><span class="p">),</span><span class="w">           </span><span class="c1"># wind_max</span>
<span class="w">                </span><span class="n">cS</span><span class="p">(</span><span class="nv">$BPAvg</span><span class="p">),</span><span class="w">             </span><span class="c1"># bp_avg_sl</span>
<span class="w">                </span><span class="nv">$log_fh</span><span class="w">                 </span><span class="c1"># log_file_handle</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Write out the TimeMDY date to a special table that is used to quickly</span>
<span class="w">      </span><span class="c1"># populate the date combo box</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$database_type</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;access&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nv">$sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;INSERT INTO DaysGleaned (TimeMDY) VALUES (&#39;$TheDate&#39;)&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="nv">$database_type</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;mysql&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nv">$sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;INSERT INTO DaysGleaned (TimeMDY) VALUES (&#39;$TheDate_mysql&#39;)&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$TelemOK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1"># For DaysGleaned table, we don&#39;t care about duplicate entries</span>
<span class="w">         </span><span class="c1"># Pass quiet=1 to suppress console output</span>
<span class="w">         </span><span class="n">execute_sql</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span><span class="w"> </span><span class="nv">$log_fh</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1"># Here is the corresponding else of the if-values-are-reasonable block.</span>
<span class="w">      </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;$TheDate, $TheHour, $TheMin, $StationNumber, $TheCity, $TempAvg, $DewPoint, $WindStuff, $WindDir, $WindAvg, $WindMax, $BPAvg\n&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;  Record failed reasonable test\n&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">sub</span><span class="w"> </span><span class="nf">getpage</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$URL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="w">   </span><span class="c1"># The next 9 elements passed in are supplied by the Now array in the main</span>
<span class="w">   </span><span class="c1"># body of this script.</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">@Now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nv">$_</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nv">$_</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="nv">$_</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="nv">$_</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="nv">$_</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="nv">$_</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="nv">$_</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="nv">$_</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>

<span class="w">   </span><span class="c1"># Get the page of data. Note the get function from &#39;LWP::Simple&#39; returns</span>
<span class="w">   </span><span class="c1"># undefined on error, so check for errors as follows....</span>
<span class="w">   </span><span class="nv">$foundPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">   </span><span class="k">unless</span><span class="w"> </span><span class="p">(</span><span class="nb">defined</span><span class="w"> </span><span class="p">(</span><span class="nv">$content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="nv">$URL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">print</span><span class="w"> </span><span class="nv">$log_fh</span><span class="w"> </span><span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot; Timestamp = @Now[5,4,3,2,1]\n&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="k">print</span><span class="w"> </span><span class="nv">$log_fh</span><span class="w"> </span><span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot; Could not get $URL\n&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="nv">$foundPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">sub</span><span class="w"> </span><span class="nf">dir360</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$dirString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$dirAngle</span><span class="p">;</span>

<span class="w">   </span><span class="k">if</span><span class="w">    </span><span class="p">(</span><span class="nv">$dirString</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;N&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$dirAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">360</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="w">   </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="nv">$dirString</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;NE&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$dirAngle</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mi">45</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="w">   </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="nv">$dirString</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;E&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$dirAngle</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mi">90</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="w">   </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="nv">$dirString</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;SE&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$dirAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">135</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="w">   </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="nv">$dirString</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;S&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$dirAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">180</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="w">   </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="nv">$dirString</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;SW&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$dirAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">225</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="w">   </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="nv">$dirString</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;W&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$dirAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">270</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="w">   </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="nv">$dirString</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;NW&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$dirAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">315</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="w">   </span><span class="k">else</span><span class="w">                       </span><span class="p">{</span><span class="w"> </span><span class="nv">$dirAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nv">$dirAngle</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub</span><span class="w"> </span><span class="nf">parseandwrite</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nv">$TheCity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1"># This offset is used to handle city names that have two words, for example &quot;THE DALLES&quot;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="w">   </span><span class="nv">$StationNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="w">   </span><span class="c1"># Split the page into lines</span>
<span class="w">   </span><span class="nv">@thelines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">split</span><span class="w"> </span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span><span class="w"> </span><span class="nv">$content</span><span class="p">);</span>
<span class="w">   </span><span class="nv">$nlines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">@thelines</span><span class="p">;</span>

<span class="w">   </span><span class="c1"># Initialize the sensor values.</span>
<span class="w">   </span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$DewPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$BPAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">;</span>

<span class="w">   </span><span class="c1"># Parse it</span>
<span class="w">   </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">@thelines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="sr">/PDT/</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="sr">/PST/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">         </span><span class="c1"># Split the line into words.</span>
<span class="w">         </span><span class="nv">@thewords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">$_</span><span class="p">);</span>

<span class="w">         </span><span class="c1"># Set this timezone parameter so the call to ParseDate works.</span>
<span class="w">         </span><span class="c1"># </span>
<span class="w">         </span><span class="c1"># Note that this does NOT override the TZ value that is set in </span>
<span class="w">         </span><span class="c1"># C:\Perl\site\lib\Date\manip.pm</span>
<span class="w">         </span><span class="c1"># I only set it here in case it is removed in manip.pm, then I correct</span>
<span class="w">         </span><span class="c1"># for the 2 hour difference down below where I shift back to </span>
<span class="w">         </span><span class="c1"># standard time.</span>
<span class="w">         </span><span class="c1">#</span>
<span class="w">         </span><span class="c1"># Changes for MN (from PST8PDT)</span>
<span class="w">         </span><span class="c1"># PST8PDT, Pacific time. MST7MDT, Mountain time. CST6CDT, Central time. EST5EDT, Eastern time</span>
<span class="w">         </span><span class="c1">#$TZ = &quot;PST8PDT&quot;;</span>
<span class="w">         </span><span class="nv">$TZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;CST6CDT&quot;</span><span class="p">;</span>

<span class="w">         </span><span class="c1"># Substitute, so can get that silly &quot;:&quot; in there. First grab the</span>
<span class="w">         </span><span class="c1"># first 4 characters. Note there is a space at the beginning of the</span>
<span class="w">         </span><span class="c1"># line so must go 1 to 5 not 0 to 4</span>

<span class="w">         </span><span class="nv">$thetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$_</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
<span class="w">         </span><span class="c1">#print &quot; thetime = $thetime \n&quot;;</span>
<span class="w">	 </span>
<span class="w">         </span><span class="c1"># If 1000, 10:00, do a special form of the substitution.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$thetime</span><span class="w"> </span><span class="o">=~</span><span class="sr"> /000/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="nv">$_</span><span class="w"> </span><span class="o">=~</span><span class="w"> </span><span class="sr">s/000/0:00/</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$_</span><span class="w"> </span><span class="o">=~</span><span class="w"> </span><span class="sr">s/00/:00/</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="c1">#print &quot; Raw stuff = $_ \n&quot;;</span>

<span class="w">         </span><span class="c1"># Parse the date to get around the problem of their am/pm format.</span>
<span class="w">         </span><span class="c1">#print &quot;TZ = $ENV{&#39;TZ&#39;}\n&quot;;</span>
<span class="w">         </span><span class="nv">$ParsedDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParseDate</span><span class="p">(</span><span class="nv">$_</span><span class="p">);</span>

<span class="w">         </span><span class="c1"># Subtract an hour to get back to standard time.</span>
<span class="w">         </span><span class="c1"># And subtract two hours to get back to Pacific time because DateCalc</span>
<span class="w">         </span><span class="c1"># tries to present the result in the local time zone.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;PDT&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$PSTDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateCalc</span><span class="p">(</span><span class="nv">$ParsedDate</span><span class="p">,</span><span class="s">&quot;- 3hours&quot;</span><span class="p">,</span><span class="o">\</span><span class="nv">$err</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$PSTDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateCalc</span><span class="p">(</span><span class="nv">$ParsedDate</span><span class="p">,</span><span class="s">&quot;- 2hours&quot;</span><span class="p">,</span><span class="o">\</span><span class="nv">$err</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="c1">#print &quot;PSTDate = $PSTDate \n&quot;;</span>

<span class="w">         </span><span class="c1"># Use this formatting function to return a date string.</span>
<span class="w">         </span><span class="nv">$TheDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnixDate</span><span class="p">(</span><span class="nv">$PSTDate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%m/%d/%Y&quot;</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">         </span><span class="c1"># Finally get the hour and min with a simple substring call</span>
<span class="w">         </span><span class="nv">$TheHour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$PSTDate</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">         </span><span class="nv">$TheMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$PSTDate</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">         </span><span class="c1">#print &quot; $TheDate, $TheHour, $TheMin \n&quot;;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1"># Look for the first occurrence of the city where the NOT AVBL string is</span>
<span class="w">      </span><span class="c1"># absent. Not that the LAST statement below will cause a break out of</span>
<span class="w">      </span><span class="c1"># the for loop; that is the mechanism I use to prevent the city from</span>
<span class="w">      </span><span class="c1"># being parsed twice if it shows more than once on the page.</span>

<span class="w">      </span><span class="c1"># Also if you&#39;re worried about getting the wrong date associated with a</span>
<span class="w">      </span><span class="c1"># city match farther down on the page, don&#39;t. If a city match is made in</span>
<span class="w">      </span><span class="c1"># a secondary report on the page, the date match will have been updated</span>
<span class="w">      </span><span class="c1"># also; it keeps trying to update the date for each line in the for loop.</span>
<span class="w">      </span><span class="c1"># So don&#39;t be afraid to use urls that have multiple reports on the page.</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="sr">/$TheCity/</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="sr">/NOT AVBL/</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1"># The sky cover is two words only for &quot;LGT RAIN&quot;</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="sr">/LGT RAIN/</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sr">/LGT SNOW/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$offset</span><span class="o">++</span><span class="p">}</span>
<span class="w">         </span><span class="nv">@thewords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">$_</span><span class="p">);</span>

<span class="w">         </span><span class="c1"># If there&#39;s a letter at the end of the pressure string, remove it.</span>
<span class="w">         </span><span class="c1"># Otherwise just take the whole thing.</span>
<span class="w">         </span><span class="nv">$PressureStuff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$offset</span><span class="p">];</span>
<span class="w">         </span><span class="nv">$PressureStuff</span><span class="w"> </span><span class="o">=~</span><span class="sr"> /[a-zA-Z]/g</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">defined</span><span class="w"> </span><span class="p">(</span><span class="nv">$FirstLetter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">pos</span><span class="p">(</span><span class="nv">$PressureStuff</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$BPAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$PressureStuff</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$FirstLetter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$BPAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$PressureStuff</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">	</span>
<span class="w">         </span><span class="c1"># Not using this anymore, but left here as an example... The</span>
<span class="w">         </span><span class="c1"># following use of substr returns all but the last character in the</span>
<span class="w">         </span><span class="c1"># target string (If the third parameter is negative, it leaves that</span>
<span class="w">         </span><span class="c1"># many off the end of the target string). Target, offset, length. </span>
<span class="w">         </span><span class="c1">#$BPAvg = substr($thewords[6 + $offset],0,-1);</span>

<span class="w">         </span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$offset</span><span class="p">];</span>
<span class="w">         </span><span class="nv">$DewPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$offset</span><span class="p">];</span>
<span class="w">         </span><span class="nv">$WindStuff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$offset</span><span class="p">];</span>

<span class="w">         </span><span class="c1"># Interpret the windstuff string.</span>

<span class="w">         </span><span class="c1"># Check for CALM</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindStuff</span><span class="w"> </span><span class="o">=~</span><span class="sr"> /CALM/g</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindStuff</span><span class="w"> </span><span class="o">=~</span><span class="sr"> /MISG/g</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1"># Split up the windstring into 4 parts.</span>
<span class="w">            </span><span class="p">(</span><span class="nv">$WindDir_string</span><span class="p">,</span><span class="nv">$WindAvg</span><span class="p">,</span><span class="nv">$Gust</span><span class="p">,</span><span class="nv">$WindMax</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$WindStuff</span><span class="w"> </span><span class="o">=~</span><span class="sr"> /(\D+)(\d+)(\D+)?(\d+)?/</span><span class="p">;</span>

<span class="w">            </span><span class="c1"># Translate the winddirection string into a number.</span>
<span class="w">            </span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dir360</span><span class="p">(</span><span class="nv">$WindDir_string</span><span class="p">);</span>

<span class="w">            </span><span class="c1"># If can&#39;t find the G (for Gust) in the wind string, just set the</span>
<span class="w">            </span><span class="c1"># max to the avg value</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$Gust</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">               </span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$WindAvg</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>

<span class="w">         </span><span class="c1"># The following call, to write out to the database, only gets run if</span>
<span class="w">         </span><span class="c1"># the city match above was successful. </span>
<span class="w">         </span><span class="n">WriteToMDB</span><span class="p">;</span>

<span class="w">         </span><span class="c1"># Use this &quot;last&quot; statement to exit the for loop. Because there are</span>
<span class="w">         </span><span class="c1"># multiple line with these city strings. This way we only use the</span>
<span class="w">         </span><span class="c1"># first find with data.</span>
<span class="w">         </span><span class="k">last</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">   </span><span class="p">}</span>

<span class="p">}</span>


<span class="c1"># \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>
<span class="c1"># Main Program</span>
<span class="c1"># \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>

<span class="c1"># Open the log file using the module function</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$log_file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;C:\Users\Jim\Documents\webcontent\waconia\wgl_perl_noaa_log.txt&#39;</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$log_success</span><span class="p">,</span><span class="w"> </span><span class="nv">$fh</span><span class="p">,</span><span class="w"> </span><span class="nv">$log_error</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open_log_file</span><span class="p">(</span><span class="nv">$log_file_path</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;NOAA Weather Data Collection Log&#39;</span><span class="p">);</span>
<span class="nv">$log_fh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$fh</span><span class="p">;</span><span class="w"> </span><span class="c1"># Assign to our variable</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nv">$log_success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">die</span><span class="w"> </span><span class="s">&quot;Failed to open log file: $log_error&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1"># Write a timestamp to the log file each time the script is run.</span>
<span class="k">print</span><span class="w"> </span><span class="nv">$log_fh</span><span class="w"> </span><span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot; from wgl_perl_noaa.pl &quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">;</span>

<span class="c1"># Initialize the Google-sheet array that will add a row of data for each successful SQL write.</span>
<span class="n">clear_google_sheet_data</span><span class="p">();</span>

<span class="nv">%shortNames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s">&#39;NORTH BEND&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;NBend&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;MOSES LAKE&#39;</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;MLake&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">               </span><span class="s">&#39;ELLENSBURG&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;EBurg&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;WALLA WALLA&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;Walla&#39;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;HERMISTON&#39;</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;Hermi&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;PASCO&#39;</span><span class="w">       </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;Pasco&#39;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;THE DALLES&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;Dalle&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;PORTLAND&#39;</span><span class="w">    </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;PLand&#39;</span><span class="p">);</span>

<span class="c1"># Make a database connection to the Access (mdb) file or MySQL database using the module</span>
<span class="nv">$database_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mysql&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1"># &quot;mysql&quot; or &quot;access&quot;</span>
<span class="p">(</span><span class="nv">$TelemOK</span><span class="p">,</span><span class="w"> </span><span class="nv">$cnTelem</span><span class="p">,</span><span class="w"> </span><span class="k">my</span><span class="w"> </span><span class="nv">$error</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connect_database</span><span class="p">(</span><span class="nv">$database_type</span><span class="p">,</span><span class="w"> </span><span class="nv">$log_fh</span><span class="p">);</span>

<span class="c1"># Get NULL value from the module</span>
<span class="nv">$null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_null</span><span class="p">(</span><span class="nv">$database_type</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nv">$TelemOK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">print</span><span class="w"> </span><span class="nv">$log_fh</span><span class="w"> </span><span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot; Error connecting to $database_type database\n&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="k">print</span><span class="w"> </span><span class="nv">$log_fh</span><span class="w"> </span><span class="s">&quot;Error: $error\n&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nb">warn</span><span class="w"> </span><span class="s">&quot;Error connecting to $database_type database: $error\n&quot;</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;Connected to $database_type database\n\n&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1"># Get the data and send it to the database.</span>
<span class="k">my</span><span class="w"> </span><span class="nv">@Now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">);</span>

<span class="c1">#getpage(&quot;http://iwin.nws.noaa.gov/iwin/wa/hourly.html&quot;, @Now);</span>
<span class="c1">#getpage(&quot;http://www.weather.gov/view/prodsByState.php?state=WA&amp;prodtype=hourly&quot;, @Now);</span>
<span class="n">getpage</span><span class="p">(</span><span class="s">&quot;http://forecast.weather.gov/product.php?site=CRH&amp;product=RWR&amp;issuedby=WA&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">@Now</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$foundPage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">parseandwrite</span><span class="p">(</span><span class="s">&quot;PORTLAND&quot;</span><span class="p">,</span><span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">51</span><span class="p">);</span>
<span class="w">   </span><span class="n">parseandwrite</span><span class="p">(</span><span class="s">&quot;THE DALLES&quot;</span><span class="p">,</span><span class="w">  </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">52</span><span class="p">);</span>
<span class="w">   </span><span class="n">parseandwrite</span><span class="p">(</span><span class="s">&quot;PASCO&quot;</span><span class="p">,</span><span class="w">       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">53</span><span class="p">);</span>
<span class="w">   </span><span class="n">parseandwrite</span><span class="p">(</span><span class="s">&quot;HERMISTON&quot;</span><span class="p">,</span><span class="w">   </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">54</span><span class="p">);</span>
<span class="w">   </span><span class="n">parseandwrite</span><span class="p">(</span><span class="s">&quot;WALLA WALLA&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">);</span>
<span class="w">   </span><span class="n">parseandwrite</span><span class="p">(</span><span class="s">&quot;ELLENSBURG&quot;</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">);</span>
<span class="w">   </span><span class="n">parseandwrite</span><span class="p">(</span><span class="s">&quot;MOSES LAKE&quot;</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1"># getpage(&quot;http://www.wrh.noaa.gov/pendleton/data/text/pdxhwrsch.html&quot;, @Now);</span>
<span class="c1"># if ($foundPage){</span>
<span class="c1">#    parseandwrite(&quot;BOARDMAN&quot;,    1, 58);</span>
<span class="c1">#    parseandwrite(&quot;IRRIGON&quot;,     1, 60);</span>
<span class="c1">#    parseandwrite(&quot;UMATILLA&quot;,    1, 61);</span>
<span class="c1">#    parseandwrite(&quot;ROOSEVELT&quot;,   0, 62);</span>
<span class="c1">#    parseandwrite(&quot;CELILO&quot;,      1, 63);</span>
<span class="c1">#    parseandwrite(&quot;RUFUS&quot;,       1, 64);</span>
<span class="c1"># }</span>

<span class="c1">#getpage(&quot;http://iwin.nws.noaa.gov/iwin/or/hourly.html&quot;, @Now);</span>
<span class="c1">#getpage(&quot;http://www.weather.gov/view/prodsByState.php?state=OR&amp;prodtype=hourly&quot;, @Now);</span>
<span class="n">getpage</span><span class="p">(</span><span class="s">&quot;http://forecast.weather.gov/product.php?site=CRH&amp;product=RWR&amp;issuedby=OR&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">@Now</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$foundPage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">parseandwrite</span><span class="p">(</span><span class="s">&quot;NORTH BEND&quot;</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">65</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1"># The following two lines of code are useful for testing the regular expression.</span>
<span class="c1"># It&#39;s just a test page on a local server.</span>

<span class="c1">#getpage(&quot;http://waconia.pnl.gov/TestWaconiaParse.htm&quot;, @Now);</span>
<span class="c1">#parseandwrite(&quot;RUFUS2&quot;,       1, 64);</span>

<span class="c1"># Close the database connection using the module</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$TelemOK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">close_database</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1"># Send the array of successful writes to the Google sheet using the module</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$row_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_google_sheet_row_count</span><span class="p">();</span>
<span class="k">print</span><span class="w"> </span><span class="s">&quot;row_count = $row_count\n&quot;</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$row_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">send_to_google_sheet</span><span class="p">(</span><span class="s">&#39;noaa&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                      </span><span class="s">&quot;C:\\Users\\Jim\\Documents\\webcontent\\waconia\\wgl_perl_noaa_data.json&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                      </span><span class="s">&quot;C:\\Users\\Jim\\Documents\\webcontent\\waconia\\wgl_perl_postToSheet.py&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="nv">$log_fh</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1"># Close the log file</span>
<span class="nb">close</span><span class="p">(</span><span class="nv">$log_fh</span><span class="p">);</span>
</pre></div>
</body>
</html>
