<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2024 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <link rel='canonical' href='https://waconia.triquence.org/gleaners/geturl.html' />
  <title>geturl</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2024 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #49483e }
body { background: #272822; color: #f8f8f2 }
body .c { color: #959077 } /* Comment */
body .err { color: #ed007e; background-color: #1e0010 } /* Error */
body .esc { color: #f8f8f2 } /* Escape */
body .g { color: #f8f8f2 } /* Generic */
body .k { color: #66d9ef } /* Keyword */
body .l { color: #ae81ff } /* Literal */
body .n { color: #f8f8f2 } /* Name */
body .o { color: #ff4689 } /* Operator */
body .x { color: #f8f8f2 } /* Other */
body .p { color: #f8f8f2 } /* Punctuation */
body .ch { color: #959077 } /* Comment.Hashbang */
body .cm { color: #959077 } /* Comment.Multiline */
body .cp { color: #959077 } /* Comment.Preproc */
body .cpf { color: #959077 } /* Comment.PreprocFile */
body .c1 { color: #959077 } /* Comment.Single */
body .cs { color: #959077 } /* Comment.Special */
body .gd { color: #ff4689 } /* Generic.Deleted */
body .ge { color: #f8f8f2; font-style: italic } /* Generic.Emph */
body .ges { color: #f8f8f2; font-weight: bold; font-style: italic } /* Generic.EmphStrong */
body .gr { color: #f8f8f2 } /* Generic.Error */
body .gh { color: #f8f8f2 } /* Generic.Heading */
body .gi { color: #a6e22e } /* Generic.Inserted */
body .go { color: #66d9ef } /* Generic.Output */
body .gp { color: #ff4689; font-weight: bold } /* Generic.Prompt */
body .gs { color: #f8f8f2; font-weight: bold } /* Generic.Strong */
body .gu { color: #959077 } /* Generic.Subheading */
body .gt { color: #f8f8f2 } /* Generic.Traceback */
body .kc { color: #66d9ef } /* Keyword.Constant */
body .kd { color: #66d9ef } /* Keyword.Declaration */
body .kn { color: #ff4689 } /* Keyword.Namespace */
body .kp { color: #66d9ef } /* Keyword.Pseudo */
body .kr { color: #66d9ef } /* Keyword.Reserved */
body .kt { color: #66d9ef } /* Keyword.Type */
body .ld { color: #e6db74 } /* Literal.Date */
body .m { color: #ae81ff } /* Literal.Number */
body .s { color: #e6db74 } /* Literal.String */
body .na { color: #a6e22e } /* Name.Attribute */
body .nb { color: #f8f8f2 } /* Name.Builtin */
body .nc { color: #a6e22e } /* Name.Class */
body .no { color: #66d9ef } /* Name.Constant */
body .nd { color: #a6e22e } /* Name.Decorator */
body .ni { color: #f8f8f2 } /* Name.Entity */
body .ne { color: #a6e22e } /* Name.Exception */
body .nf { color: #a6e22e } /* Name.Function */
body .nl { color: #f8f8f2 } /* Name.Label */
body .nn { color: #f8f8f2 } /* Name.Namespace */
body .nx { color: #a6e22e } /* Name.Other */
body .py { color: #f8f8f2 } /* Name.Property */
body .nt { color: #ff4689 } /* Name.Tag */
body .nv { color: #f8f8f2 } /* Name.Variable */
body .ow { color: #ff4689 } /* Operator.Word */
body .pm { color: #f8f8f2 } /* Punctuation.Marker */
body .w { color: #f8f8f2 } /* Text.Whitespace */
body .mb { color: #ae81ff } /* Literal.Number.Bin */
body .mf { color: #ae81ff } /* Literal.Number.Float */
body .mh { color: #ae81ff } /* Literal.Number.Hex */
body .mi { color: #ae81ff } /* Literal.Number.Integer */
body .mo { color: #ae81ff } /* Literal.Number.Oct */
body .sa { color: #e6db74 } /* Literal.String.Affix */
body .sb { color: #e6db74 } /* Literal.String.Backtick */
body .sc { color: #e6db74 } /* Literal.String.Char */
body .dl { color: #e6db74 } /* Literal.String.Delimiter */
body .sd { color: #e6db74 } /* Literal.String.Doc */
body .s2 { color: #e6db74 } /* Literal.String.Double */
body .se { color: #ae81ff } /* Literal.String.Escape */
body .sh { color: #e6db74 } /* Literal.String.Heredoc */
body .si { color: #e6db74 } /* Literal.String.Interpol */
body .sx { color: #e6db74 } /* Literal.String.Other */
body .sr { color: #e6db74 } /* Literal.String.Regex */
body .s1 { color: #e6db74 } /* Literal.String.Single */
body .ss { color: #e6db74 } /* Literal.String.Symbol */
body .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
body .fm { color: #a6e22e } /* Name.Function.Magic */
body .vc { color: #f8f8f2 } /* Name.Variable.Class */
body .vg { color: #f8f8f2 } /* Name.Variable.Global */
body .vi { color: #f8f8f2 } /* Name.Variable.Instance */
body .vm { color: #f8f8f2 } /* Name.Variable.Magic */
body .il { color: #ae81ff } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="c1"># geturl.pl</span>
<span class="c1"># Jim Miller, 9:31 PM Tue March 21, 2023</span>

<span class="k">use</span><span class="w"> </span><span class="nn">LWP::Simple</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">Time::Local</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">Date::Calc</span><span class="w"> </span><span class="sx">qw(Decode_Date_US Now Today Delta_Days Delta_DHMS System_Clock)</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">Win32::ODBC</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">DateTime</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">Date::Manip</span><span class="w"> </span><span class="sx">qw(ParseDate DateCalc UnixDate Delta_Format)</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">POSIX</span><span class="w"> </span><span class="sx">qw(floor)</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="nn">JSON</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="nn">strict</span><span class="p">;</span>

<span class="c1">#-------------------------------------------</span>
<span class="c1">#-----Globals-------------------------------</span>
<span class="c1">#-------------------------------------------</span>

<span class="k">my</span><span class="w"> </span><span class="nv">@Now</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$URL</span><span class="p">;</span>

<span class="k">my</span><span class="w"> </span><span class="nv">$content</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">@thelines</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$nlines</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">@thewords</span><span class="p">;</span>

<span class="k">my</span><span class="w"> </span><span class="nv">$DSN</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$TelemOK</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$cnTelem</span><span class="p">;</span>

<span class="k">my</span><span class="w"> </span><span class="nv">$StationNumber</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$StationNumber_lastletter</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$Station</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$Station_state</span><span class="p">;</span>

<span class="k">my</span><span class="w"> </span><span class="nv">$TheRawDate</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$TheRawTime</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">@TheRawTime_parts</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$TheCorrectedDateTime</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">@WeirdTime</span><span class="p">;</span>

<span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheDate</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheHour</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheMin</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheSec</span><span class="p">);</span>

<span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindDir</span><span class="p">,</span><span class="w"> </span><span class="nv">$WindAvg</span><span class="p">,</span><span class="w"> </span><span class="nv">$WindMax</span><span class="p">,</span><span class="w"> </span><span class="nv">$BPAvg</span><span class="p">,</span><span class="w"> </span><span class="nv">$TempAvg</span><span class="p">,</span><span class="w"> </span><span class="nv">$TempMax</span><span class="p">,</span><span class="w"> </span><span class="nv">$TempMin</span><span class="p">,</span><span class="w"> </span><span class="nv">$DewPoint</span><span class="p">);</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$Alt_ft</span><span class="p">;</span>

<span class="k">my</span><span class="w"> </span><span class="nv">$googleSheet_data</span><span class="p">;</span>

<span class="c1"># \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>

<span class="c1"># Subroutines</span>

<span class="k">sub</span><span class="w"> </span><span class="nf">parseTemperature</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="c1"># Consider the case where temperatures are over 100F and the fixed formatting will produce</span>
<span class="w">   </span><span class="c1"># text like this (see below) where there is no space after the = sign. If you don&#39;t parse this, the</span>
<span class="w">   </span><span class="c1"># Celsius value will be used inadvertently.</span>

<span class="cm">=pod</span>
<span class="cm">                          Celsius</span>
<span class="cm">   Ave Temp =100.3          34.06</span>
<span class="cm">   Max Temp =102.4          34.66</span>
<span class="cm">   Min Temp = 99.8          33.79</span>

<span class="cm">=cut</span>

<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$dryBulb</span><span class="p">;</span>
<span class="w">   </span><span class="c1"># Input parameters:</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$equalSign_raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$dryBulb_raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">$equalSign_raw</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nv">$dryBulb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="w"> </span><span class="nv">$equalSign_raw</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="nv">$equalSign_raw</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nv">$dryBulb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$dryBulb_raw</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nv">$dryBulb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub</span><span class="w"> </span><span class="nf">SnapTo15</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">   </span><span class="c1"># This routine is used to snap any date/time string to the nearest 15</span>
<span class="w">   </span><span class="c1"># minutes. This is useful for insuring common timestamps when doing SQL</span>
<span class="w">   </span><span class="c1"># joins needed for the delta-p plot on Waconia. The only input is a</span>
<span class="w">   </span><span class="c1"># date/time string. For example:  &quot;5/5/2000 23:16&quot;; It returns one</span>
<span class="w">   </span><span class="c1"># date/time string of the format generally returned by ParseDate.</span>

<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$ParsedDate</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DeltaDate</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DeltaInHours</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DeltaIn15mins</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$Rounded</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$CorrectedHoursDelta</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$JustTheHoursDelta</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$JustTheMinsDelta</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$AdderString</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$TheFixedDate</span><span class="p">;</span>

<span class="w">   </span><span class="c1"># Here is the input parameter...</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$TheDateAndTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="w">   </span><span class="c1"># First generate a parsedate date string;</span>

<span class="w">   </span><span class="nv">$ParsedDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Date::Manip::</span><span class="n">ParseDate</span><span class="p">(</span><span class="nv">$TheDateAndTime</span><span class="p">);</span>
<span class="w">   </span><span class="c1">#print &quot;$ParsedDate\n&quot;;</span>
<span class="w">   </span><span class="c1">#print Date::Manip::ParseDate(&quot;1/1/2000&quot;), &quot;\n&quot;;</span>

<span class="w">   </span><span class="c1"># Calculate the difference between that date and a reference date, 1/1/2000;</span>

<span class="w">   </span><span class="nv">$DeltaDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateCalc</span><span class="p">(</span><span class="nn">Date::Manip::</span><span class="n">ParseDate</span><span class="p">(</span><span class="s">&quot;1/1/2000&quot;</span><span class="p">),</span><span class="w"> </span><span class="nv">$ParsedDate</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">   </span><span class="c1">#print &quot; The delta = $DeltaDate \n&quot;;</span>

<span class="w">   </span><span class="c1"># Convert that difference string into a delta in hours.</span>

<span class="w">   </span><span class="nv">$DeltaInHours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Date::Manip::</span><span class="n">Delta_Format</span><span class="p">(</span><span class="nv">$DeltaDate</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%ht&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="c1">#print &quot; The delta in hours = $DeltaInHours \n&quot;;</span>

<span class="w">   </span><span class="c1"># And next to a difference in 15-min chunks of time;</span>

<span class="w">   </span><span class="nv">$DeltaIn15mins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$DeltaInHours</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0</span><span class="p">;</span>
<span class="w">   </span><span class="c1">#print &quot; The delta in 15-mins = $DeltaIn15mins \n&quot;;</span>

<span class="w">   </span><span class="c1"># Now round that number to the nearest integer. This is the magical step</span>
<span class="w">   </span><span class="c1"># that causes the snap-to-15 event.</span>

<span class="w">   </span><span class="nv">$Rounded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&quot;%.0f&quot;</span><span class="p">,</span><span class="nv">$DeltaIn15mins</span><span class="p">);</span>
<span class="w">   </span><span class="c1">#print &quot; The rounded version = $Rounded \n&quot;;</span>

<span class="w">   </span><span class="c1"># Now convert back to hours;</span>

<span class="w">   </span><span class="nv">$CorrectedHoursDelta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Rounded</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">4.0</span><span class="p">;</span>
<span class="w">   </span><span class="c1">#print &quot; The rounded hours = $CorrectedHoursDelta \n&quot;;</span>

<span class="w">   </span><span class="c1"># Now calculate the pure hours and pure minutes parts </span>

<span class="w">   </span><span class="nv">$JustTheHoursDelta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">POSIX::</span><span class="n">floor</span><span class="p">(</span><span class="nv">$Rounded</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">4.0</span><span class="p">);</span><span class="w"> </span>
<span class="w">   </span><span class="c1">#print &quot;Just the hours = $JustTheHoursDelta \n&quot;;</span>
<span class="w">   </span><span class="nv">$JustTheMinsDelta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nv">$CorrectedHoursDelta</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">$JustTheHoursDelta</span><span class="p">);</span>
<span class="w">   </span><span class="c1">#print &quot;Just the minutes = $JustTheMinsDelta \n&quot;;</span>

<span class="w">   </span><span class="c1"># Make an adder string (in hours and minutes) to use relative to the 1/1/2000 date;</span>

<span class="w">   </span><span class="nv">$AdderString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;+ &quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$JustTheHoursDelta</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;Hours &quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$JustTheMinsDelta</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;Minutes&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="c1">#print &quot; $AdderString \n&quot;;</span>

<span class="w">   </span><span class="c1"># Use the adder string to calcualate the fixed (snapped to 15) date;</span>

<span class="w">   </span><span class="nv">$TheFixedDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Date::Manip::</span><span class="n">DateCalc</span><span class="p">(</span><span class="s">&quot;1/1/2000&quot;</span><span class="p">,</span><span class="nv">$AdderString</span><span class="p">);</span>
<span class="w">   </span><span class="c1">#print &quot;$TheFixedDate \n&quot;; </span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nv">$TheFixedDate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub</span><span class="w"> </span><span class="nf">CheckForWeirdLoggerTimeStamps</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="c1"># The arguments passed</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$SnappedTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$RawHour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w">   </span><span class="c1"># The first element in the array passed</span>

<span class="w">   </span><span class="c1"># Local variables</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$CorrectedDateTime</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DD</span><span class="p">;</span><span class="w"> </span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DH</span><span class="p">;</span><span class="w"> </span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DM</span><span class="p">;</span><span class="w"> </span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DS</span><span class="p">;</span>

<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$TheDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnixDate</span><span class="p">(</span><span class="nv">$SnappedTime</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%m/%d/%Y&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$TheHour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$SnappedTime</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$TheMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$SnappedTime</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$TheSec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$SnappedTime</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="w">  </span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DecimalDayDiff</span><span class="p">;</span>

<span class="w">   </span><span class="c1"># Check for weird time stamps (around midnight) that are used by some of the</span>
<span class="w">   </span><span class="c1"># HMS data loggers. Look at the difference between the system clock and the </span>
<span class="w">   </span><span class="c1"># snapped time.</span>

<span class="w">   </span><span class="p">(</span><span class="nv">$DD</span><span class="p">,</span><span class="nv">$DH</span><span class="p">,</span><span class="nv">$DM</span><span class="p">,</span><span class="nv">$DS</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Delta_DHMS</span><span class="p">(</span><span class="n">Today</span><span class="p">(),</span><span class="w"> </span><span class="n">Now</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                                  </span><span class="n">Decode_Date_US</span><span class="p">(</span><span class="nv">$TheDate</span><span class="p">),</span><span class="w"> </span><span class="nv">$TheHour</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheMin</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheSec</span><span class="p">);</span><span class="w">   </span>

<span class="w">   </span><span class="c1"># This DecimalDayDiff calc should really be done after the time correction is made and account for</span>
<span class="w">   </span><span class="c1"># daylight savings time.</span>
<span class="w">   </span><span class="nv">$DecimalDayDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$DD</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$DH</span><span class="sr">/24.0 + $DM/</span><span class="p">(</span><span class="mf">24.0</span><span class="o">*</span><span class="mf">60.0</span><span class="p">);</span>

<span class="w">   </span><span class="c1"># If there is more than a 5 hour difference and its around midnight</span>
<span class="w">   </span><span class="c1"># it must be a one of the suspect loggers.</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w">  </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nv">$DH</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="nv">$RawHour</span><span class="o">==</span><span class="mi">23</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nv">$RawHour</span><span class="o">==</span><span class="mi">24</span><span class="p">))</span><span class="w">   </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nv">$CorrectedDateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Date::Manip::</span><span class="n">DateCalc</span><span class="p">(</span><span class="nv">$SnappedTime</span><span class="p">,</span><span class="s">&quot;- 1 days&quot;</span><span class="p">);</span><span class="w"> </span>
<span class="w">      </span><span class="k">print</span><span class="w"> </span><span class="s">&quot; Differences from system clock (d,h,m,s):  $DD,$DH,$DM,$DS  $CorrectedDateTime  \n&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nv">$CorrectedDateTime</span><span class="p">,</span><span class="w"> </span><span class="nv">$DecimalDayDiff</span><span class="p">);</span><span class="w">  </span><span class="c1"># return an array with two elements...</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nv">$SnappedTime</span><span class="p">,</span><span class="w"> </span><span class="nv">$DecimalDayDiff</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">sub</span><span class="w"> </span><span class="nf">cS</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="c1"># clearString (cS)</span>
<span class="w">   </span><span class="c1"># This prepares values before writing to the Google sheet.</span>
<span class="w">   </span><span class="c1"># It translates the Null to an empty string.</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$stringValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$stringValue</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nv">$stringValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nv">$stringValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub</span><span class="w"> </span><span class="nf">WriteToMDB</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DateTimeStamp</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$LiteralDateTimeStamp</span><span class="p">;</span>

<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheYear</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheMonth</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheDay</span><span class="p">);</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="p">(</span><span class="nv">$Waconia_Year</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Month</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Day</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Hour</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Min</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Sec</span><span class="p">);</span>

<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$PerlTime</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$DateTimeStamp</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$LiteralDateTimeStamp</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$sql</span><span class="p">;</span>

<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">@SystemClock</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$NextDayDate</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$t_c</span><span class="p">;</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$h_m</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$BPAvg_sl</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">@newRow_googleSheet</span><span class="p">;</span>

<span class="w">   </span><span class="c1"># Here is the HMS data date</span>
<span class="w">   </span><span class="p">(</span><span class="nv">$TheYear</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheMonth</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheDay</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Decode_Date_US</span><span class="p">(</span><span class="nv">$TheDate</span><span class="p">);</span>

<span class="w">   </span><span class="c1"># Here is the server date and time </span>
<span class="w">   </span><span class="p">(</span><span class="nv">$Waconia_Year</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Month</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Day</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Today</span><span class="p">();</span>
<span class="w">   </span><span class="p">(</span><span class="nv">$Waconia_Hour</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Min</span><span class="p">,</span><span class="w"> </span><span class="nv">$Waconia_Sec</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Now</span><span class="p">();</span>

<span class="w">   </span><span class="c1">#Timelocal requires that months start with zero.</span>
<span class="w">   </span><span class="nv">$PerlTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timelocal</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="nv">$Waconia_Min</span><span class="p">),(</span><span class="nv">$Waconia_Hour</span><span class="p">),(</span><span class="nv">$Waconia_Day</span><span class="p">),(</span><span class="nv">$Waconia_Month</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nv">$Waconia_Year</span><span class="p">);</span>

<span class="w">   </span><span class="c1"># Create the SQL statement for inserting a record of data into the mdb file.</span>
<span class="w">  </span>
<span class="w">   </span><span class="nv">$DateTimeStamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$TheMonth</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$TheDay</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$TheYear</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$TheHour</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$TheMin</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$LiteralDateTimeStamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$TheRawDate</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$TheRawTime</span><span class="p">;</span>

<span class="w">   </span><span class="c1"># Check for bad values.</span>
<span class="w">   </span><span class="c1"># This puts an unquoted Null in the SQL string if there is a bad value.</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1"># Correct the pressure reading to be at sea-level altitude</span>
<span class="w">   </span><span class="c1"># Note: here are two different ways to do this correction. This syntax is python.</span>
<span class="w">   </span><span class="c1"># h_m = 390 / 3.28084</span>
<span class="w">   </span><span class="c1"># p_station = 29.565</span>
<span class="w">   </span><span class="c1"># t_k = (81.6 +  459.67) * 5.0/9.0</span>
<span class="w">   </span><span class="c1"># t_c = (81.6 - 32.0) * 5.0/9.0</span>
<span class="w">   </span><span class="c1"># A power-law model form:</span>
<span class="w">   </span><span class="c1"># p_sl = p_station * ((1 - ((0.0065*h_m)/(t_c + (0.0065*h_m) + 273.15))) ** (-5.257))</span>
<span class="w">   </span><span class="c1"># An exponential model form:</span>
<span class="w">   </span><span class="c1"># p_sl = p_station / math.exp(-h_m/(t_k*29.263))</span>
<span class="w">   </span>
<span class="w">   </span><span class="nv">$t_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">32.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">5.0</span><span class="o">/</span><span class="mf">9.0</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$h_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Alt_ft</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">3.28084</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$BPAvg</span><span class="w"> </span><span class="ow">ne</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1"># Using the power-law correction:</span>
<span class="w">      </span><span class="nv">$BPAvg_sl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$BPAvg</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">((</span><span class="mf">0.0065</span><span class="o">*</span><span class="nv">$h_m</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nv">$t_c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0065</span><span class="o">*</span><span class="nv">$h_m</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">273.15</span><span class="p">)))</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">5.257</span><span class="p">));</span>
<span class="w">      </span><span class="c1"># Round to 4 digits.</span>
<span class="w">      </span><span class="nv">$BPAvg_sl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&quot;%.4f&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">$BPAvg_sl</span><span class="p">);</span>
<span class="w">      </span><span class="c1">#print &quot;t_c=$t_c, Alt_ft=$Alt_ft, h_m=$h_m, P_raw=$BPAvg, P_SL=$BPAvg_sl\n&quot;;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Check for extreme BPAvg_sl values.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nv">$BPAvg_sl</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">29.0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nv">$BPAvg_sl</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">31.0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;Pressure value, $BPAvg_sl, nulled for station $Station.\n&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nv">$BPAvg_sl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nv">$BPAvg_sl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1"># Check for extreme TempMin values. </span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">$TempMin</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nv">$TempMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="c1"># Null out the direction value for any calm readings.</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1"># Note that in the VALUES part of the SQL, strings and dates are quoted, numbers are not.</span>
<span class="w">   </span><span class="nv">$sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;INSERT INTO FifteenMinData (PerlTime, DateTimeStamp, LiteralDateTimeStamp, TimeMDY, TimeHr, TimeMin, StationNumber, &quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$sql</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s">&quot;StationName, WindDirection, WindSpeed, WindGust, &quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$sql</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s">&quot;TempAvg, TempMax, TempMin, Pressure, DewPoint) &quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$sql</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s">&quot;VALUES ($PerlTime,&#39;$DateTimeStamp&#39;,&#39;$LiteralDateTimeStamp&#39;,&#39;$TheDate&#39;,$TheHour,$TheMin,$StationNumber,&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nv">$sql</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s">&quot;&#39;$Station&#39;,$WindDir,$WindAvg,$WindMax,$TempAvg,$TempMax,$TempMin,$BPAvg_sl,$DewPoint)&quot;</span><span class="p">;</span>

<span class="w">   </span><span class="c1"># If all numeric values are reasonable, write the record...</span>
<span class="w">   </span><span class="c1"># Note: one or more of these raw values may be a &quot;Null&quot; string. Those clauses always evaluate true and do not block the write.</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w">  </span><span class="p">((</span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">-</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w">  </span><span class="mi">120</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">         </span><span class="p">((</span><span class="nv">$TempMax</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">-</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$TempMax</span><span class="w"> </span><span class="o">&lt;=</span><span class="w">  </span><span class="mi">120</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="p">((</span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">&gt;=</span><span class="w">   </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w">  </span><span class="mi">130</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="p">((</span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">&gt;=</span><span class="w">   </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">&lt;=</span><span class="w">  </span><span class="mi">150</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="p">((</span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">&gt;=</span><span class="w">   </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">&lt;=</span><span class="w">  </span><span class="mi">360</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">         </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nv">$StationNumber</span><span class="w"> </span><span class="ow">ne</span><span class="w"> </span><span class="s">&quot;19a&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nv">$StationNumber</span><span class="w"> </span><span class="ow">ne</span><span class="w"> </span><span class="s">&quot;6a&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="p">((</span><span class="nv">$TheHour</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheHour</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">23</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="p">((</span><span class="nv">$TheMin</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheMin</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">59</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="p">(</span><span class="nv">$WeirdTime</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">100.00</span><span class="p">)</span><span class="w">   </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1"># Decimal day check for dead loggers that are dragging their time stamps into the next day...</span>

<span class="w">      </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;$TheDate, $TheHour, $TheMin, $StationNumber, $Station, WIND: $WindDir, $WindAvg, $WindMax, PRESSURE: $BPAvg_sl, TEMP: $TempAvg, $TempMax, $TempMin, $DewPoint\n&quot;</span><span class="p">;</span>

<span class="w">      </span><span class="c1"># Execute the SQL. Write weather data to the database.</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Error checking here: the SQL method returns undefined if it is</span>
<span class="w">      </span><span class="c1"># successful and a non-zero integer error number if it fails.</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$TelemOK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$cnTelem</span><span class="o">-&gt;</span><span class="n">Sql</span><span class="p">(</span><span class="nv">$sql</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;  Waconia: SQL failed (probably the record already exists).\n&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="c1"># If not the -1605 error message (duplicate records) then log it.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$cnTelem</span><span class="o">-&gt;</span><span class="n">Error</span><span class="p">()</span><span class="w"> </span><span class="o">=~</span><span class="sr"> /-1605/</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">print</span><span class="w"> </span><span class="n">OUTPUTFILE</span><span class="w"> </span><span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot; Waconia SQL failure, Error: &quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$cnTelem</span><span class="o">-&gt;</span><span class="n">Error</span><span class="p">()</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;, SQL=&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$sql</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;SQL write succeeded, &quot;</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1"># Prepare to add a new row to the googleSheet_data array.</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">my</span><span class="w"> </span><span class="nv">$pt_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">DateTime</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
<span class="w">                </span><span class="n">year</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">$TheYear</span><span class="p">,</span>
<span class="w">                </span><span class="n">month</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">$TheMonth</span><span class="p">,</span>
<span class="w">                </span><span class="n">day</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">$TheDay</span><span class="p">,</span>
<span class="w">                </span><span class="n">hour</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">$TheHour</span><span class="p">,</span>
<span class="w">                </span><span class="n">minute</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">$TheMin</span><span class="p">,</span>
<span class="w">                </span><span class="n">second</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">my</span><span class="w"> </span><span class="nv">$pt_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$pt_time</span><span class="o">-&gt;</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%m/%d/%Y %H:%M:%S&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;PST= $pt_string, &quot;</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">my</span><span class="w"> </span><span class="nv">$utc_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$pt_time</span><span class="o">-&gt;</span><span class="nn">clone</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">hours</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">my</span><span class="w"> </span><span class="nv">$utc_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$utc_time</span><span class="o">-&gt;</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%m/%d/%Y %H:%M:%S&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;UTC= $utc_string\n&quot;</span><span class="p">;</span>
<span class="w">                        </span>
<span class="w">            </span><span class="nv">@newRow_googleSheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">$Station</span><span class="p">,</span><span class="w"> </span><span class="nv">$utc_string</span><span class="p">,</span><span class="w"> </span><span class="n">cS</span><span class="p">(</span><span class="nv">$TempAvg</span><span class="p">),</span><span class="w"> </span><span class="n">cS</span><span class="p">(</span><span class="nv">$DewPoint</span><span class="p">),</span><span class="w"> </span><span class="n">cS</span><span class="p">(</span><span class="nv">$WindDir</span><span class="p">),</span><span class="w"> </span><span class="n">cS</span><span class="p">(</span><span class="nv">$WindAvg</span><span class="p">),</span><span class="w"> </span><span class="n">cS</span><span class="p">(</span><span class="nv">$WindMax</span><span class="p">),</span><span class="w"> </span><span class="n">cS</span><span class="p">(</span><span class="nv">$BPAvg_sl</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="nb">push</span><span class="w"> </span><span class="nv">@$googleSheet_data</span><span class="p">,</span><span class="w"> </span><span class="o">\</span><span class="nv">@newRow_googleSheet</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1"># Write out the TimeMDY date to a special table that is used to quickly populate the date combo box.</span>
<span class="w">      </span><span class="c1"># Check for special case of Daylight Savings time AND the PST hour of 23. </span>
<span class="w">      </span><span class="c1"># Otherwise you won&#39;t be able to request a chart from midnight to 1AM.</span>
<span class="w">      </span><span class="c1"># The ninth element in the returned array is a boolean for daylight savings time...</span>
<span class="w">      </span>
<span class="w">      </span><span class="nv">@SystemClock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System_Clock</span><span class="p">();</span><span class="w"> </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nv">$SystemClock</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheHour</span><span class="o">==</span><span class="mi">23</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nv">$NextDayDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnixDate</span><span class="p">(</span><span class="w"> </span><span class="nn">Date::Manip::</span><span class="n">DateCalc</span><span class="p">(</span><span class="w"> </span><span class="nv">$TheDate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;+ 1 days&quot;</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%m/%d/%Y&quot;</span><span class="p">);</span><span class="w"> </span>
<span class="w">         </span><span class="c1">#print &quot;Next Day = $NextDayDate\n&quot;;</span>
<span class="w">         </span><span class="nv">$sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;INSERT INTO DaysGleaned (TimeMDY) VALUES (&#39;$NextDayDate&#39;)&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nv">$sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;INSERT INTO DaysGleaned (TimeMDY) VALUES (&#39;$TheDate&#39;)&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$TelemOK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$cnTelem</span><span class="o">-&gt;</span><span class="n">Sql</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);}</span>

<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;Record failed reasonable test\n&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;  $TheDate, $TheHour, $TheMin, $StationNumber, $Station, WIND: $WindDir, $WindAvg, $WindMax, PRESSURE: $BPAvg_sl, TEMP: $TempAvg, $TempMax, $TempMin, $DewPoint\n&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="p">}</span>

<span class="c1"># \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</span>

<span class="c1"># Main Program Body</span>

<span class="c1"># Open the log file. Note the &#39;$!&#39; variable returns system errors.</span>

<span class="nv">@Now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">);</span>

<span class="nb">open</span><span class="p">(</span><span class="n">OUTPUTFILE</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;&gt;&gt;C:\Users\Jim\Documents\webcontent\waconia\rosielog.txt&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;Timestamp = @Now[5,4,3,2,1]\n&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="k">print</span><span class="w"> </span><span class="s">&quot;Could not find rosielog.txt\n&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nb">die</span><span class="w"> </span><span class="s">&quot;On open (Jdm): $!&quot;</span><span class="p">;</span>
<span class="p">};</span><span class="w">  </span><span class="c1"># This semicolon is important here....</span>

<span class="k">print</span><span class="w"> </span><span class="n">OUTPUTFILE</span><span class="w"> </span><span class="nb">localtime</span><span class="p">(</span><span class="nb">time</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot; from geturl.pl &quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">;</span>

<span class="c1"># 5:14 PM Tue February 28, 2023. Yesterday the Perl &quot;get&quot; stopped working for the Hanford page. Left it here in</span>
<span class="c1"># comments. Replaced it with a call to a little Python script that fetches the page and puts it in a file.</span>

<span class="c1"># Get the page of data. Note the get function from &#39;LWP::Simple&#39; returns undefined on error, so check for</span>
<span class="c1"># errors as follows....</span>
<span class="c1">#$URL = &quot;http://hms.rl.gov/stainfo.htm&quot;;</span>
<span class="c1">#$URL = &quot;http://hms.pnl.gov/stainfo.htm&quot;;</span>

<span class="c1">#$URL = &quot;https://www.hanford.gov/c.cfm/hms/realtime.cfm&quot;;</span>
<span class="c1"># unless (defined ($content = get $URL)) {</span>
<span class="w">   </span><span class="c1"># print OUTPUTFILE &quot;Timestamp = @Now[5,4,3,2,1]\n&quot;;</span>
<span class="w">   </span><span class="c1"># print OUTPUTFILE &quot;Could not get $URL\n&quot;;</span>
<span class="w">   </span><span class="c1"># close(OUTPUTFILE); </span>
<span class="w">   </span><span class="c1"># my $error_message = getprint($URL);</span>
<span class="w">   </span><span class="c1"># die &quot;Could not get $URL\n $error_message\n&quot;;</span>
<span class="c1"># }</span>

<span class="k">my</span><span class="w"> </span><span class="nv">$cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;C:\\Users\\Jim\\Documents\\webcontent\\waconia\\pythonURLfetch.py&quot;</span><span class="p">;</span>
<span class="k">print</span><span class="w"> </span><span class="s">&quot;Before system call to run the Python script that fetches the Hanford page.\n&quot;</span><span class="p">;</span>
<span class="nb">system</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span><span class="w">  </span>
<span class="c1"># Note the &quot;system&quot; call is blocking and so this next statement won&#39;t run until the fetch completes.</span>
<span class="k">print</span><span class="w"> </span><span class="s">&quot;After system call.\n&quot;</span><span class="p">;</span>

<span class="c1"># Read in the txt file.</span>
<span class="nb">open</span><span class="p">(</span><span class="k">my</span><span class="w"> </span><span class="nv">$fh</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;urldump.txt&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nb">die</span><span class="w"> </span><span class="s">&quot;Could not open file: $!&quot;</span><span class="p">;</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">local</span><span class="w"> </span><span class="vg">$/</span><span class="p">;</span><span class="w"> </span><span class="sr">&lt;$fh&gt;</span><span class="w"> </span><span class="p">};</span>
<span class="nb">close</span><span class="p">(</span><span class="nv">$fh</span><span class="p">);</span>

<span class="c1"># Split the contents into lines.</span>
<span class="nv">@thelines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">split</span><span class="w"> </span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span><span class="w"> </span><span class="nv">$content</span><span class="p">);</span>
<span class="nv">$nlines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">@thelines</span><span class="p">;</span>

<span class="c1"># Make a database connection objects and point them at the mdb files. A future improvement here would</span>
<span class="c1"># be to set some flags so that only if both connections fail it exits. If there is at least one good</span>
<span class="c1"># connection, then proceed to the SQL execution, but only execute for the good connection.</span>

<span class="nv">$DSN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;DRIVER={Microsoft Access Driver (*.mdb)};DBQ=C:/Users/Jim/Documents/webcontent/waconia/data/telem.mdb;UID=admin&quot;</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$cnTelem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nn">Win32::</span><span class="n">ODBC</span><span class="p">(</span><span class="nv">$DSN</span><span class="p">))){</span>
<span class="w">    </span><span class="k">print</span><span class="w"> </span><span class="n">OUTPUTFILE</span><span class="w"> </span><span class="s">&quot;Timestamp = @Now[5,4,3,2,1]\n&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">print</span><span class="w"> </span><span class="n">OUTPUTFILE</span><span class="w"> </span><span class="s">&quot;Error connecting to $DSN\n&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">print</span><span class="w"> </span><span class="n">OUTPUTFILE</span><span class="w"> </span><span class="s">&quot;Error: &quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nn">Win32::ODBC::</span><span class="n">Error</span><span class="p">()</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="nv">$TelemOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="nb">warn</span><span class="w"> </span><span class="s">&quot;Error connecting to $DSN\n&quot;</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nv">$TelemOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1"># Note: I have left rain gauge out of this data collection script. It is hard</span>
<span class="c1"># to include because it is the last entry in each section and/but some sections</span>
<span class="c1"># don&#39;t have it at all. The list of those that don&#39;t have it are EDNA, FRNK,</span>
<span class="c1"># GABL, PFP, GABW, VERN, HAMR. The write statement has to trigger on something</span>
<span class="c1"># that is common to all sections. Otherwise that section will just not get</span>
<span class="c1"># printed out. To make this work you would have to extend the 2 tier code that</span>
<span class="c1"># groups on those that are like FFTP and those that are not, to a 3 tier</span>
<span class="c1"># grouping: (1) like FFTP, (2a) not like FFTP and with Rain gauge, (2b) not</span>
<span class="c1"># like FFTP and without Rain gauge. </span>

<span class="c1">#print &quot;$nlines \n&quot;;</span>

<span class="nv">$Station</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="nv">$Alt_ft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="c1"># Initialize the Google-sheet array that will add a row of data for each successful SQL write.</span>
<span class="nv">$googleSheet_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span><span class="p">;</span>

<span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">@thelines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="sr">/Station\#/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">      </span><span class="nv">@thewords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">$_</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Some stations might be listed on the page but be decommissioned or temporarily down.</span>
<span class="w">      </span><span class="c1"># This flag can be used to make note if there is an indication given that it&#39;s not active.</span>
<span class="w">      </span><span class="nv">$Station_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ON&quot;</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span>
<span class="w">      </span><span class="nv">$StationNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$StationNumber</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;19a&quot;</span><span class="p">){</span>
<span class="w">        </span><span class="c1"># Remove the letter from StationNumber (i.e., the a).</span>
<span class="w">        </span><span class="c1">#$StationNumber_lastletter = chop($StationNumber)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Or better yet, just use 31, the old number for this site. Can&#39;t use 19 because the database</span>
<span class="w">        </span><span class="c1"># key includes the station number and 19 is already being used.</span>
<span class="w">        </span><span class="nv">$StationNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">31</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">         </span><span class="c1"># Case with spaces, e.g. (  345) or ( 2345)</span>
<span class="w">         </span><span class="c1"># Remove the &quot;)&quot; at the end of the station name string.</span>
<span class="w">         </span><span class="nv">$Station</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span>
<span class="w">         </span><span class="nv">$Alt_ft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1"># Case where there are no spaces, e.g.: (12345)</span>
<span class="w">         </span><span class="nv">$Station</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">         </span><span class="nv">$Alt_ft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="c1"># Ignore the following station-name strings</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;Telemetry&quot;</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;no&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nv">$Station_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;OFF&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Each time you find a new station section on the page initialize sensor values. Note that</span>
<span class="w">      </span><span class="c1"># not every sensor type is available at all stations, so it&#39;s important to set to Null here</span>
<span class="w">      </span><span class="c1"># in those cases.      </span>
<span class="w">      </span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="nv">$BPAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="nv">$TempMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="nv">$TempMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="nv">$DewPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="sr">/Time:/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nv">@thewords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">$_</span><span class="p">);</span>
<span class="w">      </span><span class="nv">$TheRawDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">      </span><span class="nv">$TheRawTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="w">      </span><span class="c1"># If there&#39;s not a problem with the timestamp, run SnapTo15..</span>
<span class="w">      </span><span class="c1"># Note that this check is applied here (to avoid errors in SnapTo15) and also</span>
<span class="w">      </span><span class="c1"># below in the next block...</span>
<span class="w">      </span>
<span class="w">      </span><span class="nv">@TheRawTime_parts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">$TheRawTime</span><span class="p">);</span><span class="w">       </span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$TheRawTime_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="ow">ne</span><span class="w"> </span><span class="s">&quot;99&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	 </span>
<span class="w">         </span><span class="c1"># Nudge the date/time to the nearest 15 minutes.</span>

<span class="w">         </span><span class="nv">$TheCorrectedDateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SnapTo15</span><span class="p">(</span><span class="nv">$TheRawDate</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">$TheRawTime</span><span class="p">);</span>

<span class="w">         </span><span class="nv">@WeirdTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckForWeirdLoggerTimeStamps</span><span class="p">(</span><span class="nv">$TheCorrectedDateTime</span><span class="p">,</span><span class="w"> </span><span class="nv">@TheRawTime_parts</span><span class="p">);</span>
<span class="w">         </span><span class="nv">$TheCorrectedDateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">@WeirdTime</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="c1"># The first array element is the fixed time...</span>

<span class="w">         </span><span class="nv">$TheDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnixDate</span><span class="p">(</span><span class="nv">$TheCorrectedDateTime</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%m/%d/%Y&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">         </span><span class="nv">$TheHour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$TheCorrectedDateTime</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="w">         </span><span class="nv">$TheMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$TheCorrectedDateTime</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="w">         </span><span class="nv">$TheSec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">substr</span><span class="p">(</span><span class="nv">$TheCorrectedDateTime</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="c1"># Look for the strings that indicate whether or not station is collecting data.</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="sr">/Temporarily Unavailable/</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="sr">/Decommissioned/</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="nv">$Station_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;OFF&quot;</span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1"># Don&#39;t process this station if it has a bad date or if it is OFF for some reason.</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nv">$TheRawTime_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="ow">ne</span><span class="w"> </span><span class="s">&quot;99&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$Station_state</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;ON&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># This block does the main parsing by looking for defining strings in each line.</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Split the line up by the spaces in it.</span>
<span class="w">      </span><span class="nv">@thewords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">$_</span><span class="p">);</span><span class="w">  </span>
<span class="w">            </span>
<span class="w">      </span><span class="c1"># Divide stations into two categories. The first group is contains 3 stations </span>
<span class="w">      </span><span class="c1"># that have more detailed reporting and use a slightly different nomenclature</span>
<span class="w">      </span><span class="c1"># because of sensors positioned at various heights.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nv">$Station</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;FFTF&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nv">$Station</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;300A&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nv">$Station</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;100N&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="sr">/Ave Wind Direction 10m/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindDir</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;-999&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Ave Wind Speed 10m/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindAvg</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;-999&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Max Wind Speed 10m/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindMax</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;-999&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Ave BP/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$BPAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="w">            </span><span class="c1">#print &quot;Pressure reading at &quot; . $Station . &quot; = &quot; . $BPAvg . &quot;\n&quot;;</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Ave Temp 2m/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">            </span><span class="nv">$DewPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Max Temp 2m/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$TempMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Min Temp 2m/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$TempMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">         </span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># This second group covers the remainder of the stations on the page.</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="sr">/Ave Wind Direction/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindDir</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;-999&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$WindDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Ave Wind Speed/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindAvg</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;-999&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$WindAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Max Wind Speed/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$WindMax</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;-999&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$WindMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Ave BP/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$BPAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="w">            </span><span class="c1">#print &quot;Pressure reading at &quot; . $Station . &quot; = &quot; . $BPAvg . &quot;\n&quot;;</span>

<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Ave Temp/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1"># This forces the first Ave Temp reading within each station group. Some</span>
<span class="w">            </span><span class="c1"># stations have second building, so this prevents that temperature reading</span>
<span class="w">            </span><span class="c1"># from being used.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$TempAvg</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$TempAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseTemperature</span><span class="p">(</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">3</span><span class="p">]);}</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Station</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">&quot;200E&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nv">$DewPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Max Temp/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$TempMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseTemperature</span><span class="p">(</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span><span class="w"> </span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Min Temp/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">$TempMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseTemperature</span><span class="p">(</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span><span class="w"> </span>
<span class="w">         </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">(</span><span class="sr">/Dew Point/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1"># RMTN</span>
<span class="w">            </span><span class="nv">$DewPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w"> </span>
<span class="w">         </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">elsif</span><span class="w"> </span><span class="p">((</span><span class="sr">/DewPt/</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="sr">/RH/</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1"># HMS</span>
<span class="w">            </span><span class="nv">$DewPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thewords</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"> </span>
<span class="w">         </span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="c1"># divide stations into two categories...  </span>

<span class="w">      </span><span class="c1"># Write to the database at the end of each station section on the web page.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="sr">/Return to Map/</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">$Station</span><span class="w"> </span><span class="ow">ne</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">WriteToMDB</span><span class="p">;</span>
<span class="w">         </span><span class="nv">$Station</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Null&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w">   </span>
<span class="w">      </span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="c1"># Check for bad date</span>
<span class="p">}</span><span class="w"> </span><span class="c1">#For each line...</span>

<span class="c1"># Close the database and file connections</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$TelemOK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$cnTelem</span><span class="o">-&gt;</span><span class="n">Close</span><span class="p">();}</span>
<span class="nb">close</span><span class="p">(</span><span class="n">OUTPUTFILE</span><span class="p">);</span><span class="w"> </span>

<span class="c1"># Send the array of successful writes to the Google sheet.</span>
<span class="k">my</span><span class="w"> </span><span class="nv">$row_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">scalar</span><span class="w"> </span><span class="nv">@$googleSheet_data</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$row_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span>
<span class="w">   </span><span class="c1"># Put the data into a JSON data structure.</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$json_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="s">&#39;sheetName&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;hanford&#39;</span><span class="p">,</span>
<span class="w">       </span><span class="s">&#39;weatherData&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">$googleSheet_data</span>
<span class="w">   </span><span class="p">};</span>

<span class="w">   </span><span class="c1"># Convert the JSON data to a string.</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$json_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encode_json</span><span class="p">(</span><span class="nv">$json_data</span><span class="p">);</span>

<span class="w">   </span><span class="c1"># Write the string to the file.</span>
<span class="w">   </span><span class="nb">open</span><span class="p">(</span><span class="k">my</span><span class="w"> </span><span class="nv">$fh</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;data.json&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nb">die</span><span class="w"> </span><span class="s">&quot;Can&#39;t open file: $!&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="k">print</span><span class="w"> </span><span class="nv">$fh</span><span class="w"> </span><span class="nv">$json_string</span><span class="p">;</span>
<span class="w">   </span><span class="nb">close</span><span class="w"> </span><span class="nv">$fh</span><span class="p">;</span>

<span class="w">   </span><span class="c1"># Run the Python program that reads the file and Posts the JSON to the spreadsheet. Specify the file as an argument.</span>
<span class="w">   </span><span class="k">my</span><span class="w"> </span><span class="nv">$cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;C:\\Users\\Jim\\Documents\\webcontent\\waconia\\pythonPostToSheet.py data.json&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="nb">system</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span><span class="w">   </span>
<span class="p">}</span>
</pre></div>
</body>
</html>
